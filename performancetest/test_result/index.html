<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>性能测试报告</title>
    <link href="https://unpkg.com/element-ui/lib/theme-chalk/index.css" rel="stylesheet">
    <link href="https://unpkg.com/swiper/swiper-bundle.min.css" rel="stylesheet">
    <script src="https://cdn.staticfile.org/vue/2.4.2/vue.min.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/echarts/dist/echarts.min.js"></script>
    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <style>
		.el-carousel__item h3 {
		  color: #475669;
		  font-size: 14px;
		  opacity: 0.75;
		  line-height: 200px;
		  margin: 0;
		}
		
		.el-carousel__item:nth-child(2n) {
		  background-color: #fff;
		}
		
		.el-carousel__item:nth-child(2n+1) {
		  background-color: #fff;
		}
		.sticky-header {
			position: sticky;
			top: 0;
			z-index: 999;
			margin-bottom: 1rem;
			margin-top: 1rem;
			/* 其他样式 */
		}

    </style>
</head>
<body>
<div id="app">
    <div class="sticky-header">
        <el-card>
            <el-carousel :autoplay="false" :initial-index="parseInt(imgs.length/2)" :key="current_click_time_for_mountout" :loop="false"
                         arrow="never" height="16rem" indicator-position="none" type="card">
                <el-carousel-item :key="item.time" style="text-align: center;" v-for="item in imgs">
                    <!-- <img :src="item.picture_path" alt="" style="object-fit: contain;"> -->
                    <el-image
                            :preview-src-list="item.relative_time == current_click_time_for_mountout ? [item.picture_path]: []"
                            :src="item.picture_path"
                            @click="clickImg(item)"
                            fit="cover"
                            style="height: 100%;"
                    >
                        <div class="image-slot" slot="error" style="text-align: center;">
                            暂无图片
                            <i class="el-icon-picture-outline"></i>
                        </div>
                    </el-image>
                </el-carousel-item>
            </el-carousel>
        </el-card>

    </div>
    <br/>
    <div class="chartdiv">
        <el-card>
            <div :id="typeItem" :key="typeItem" class="chartitem"
                 style=" width: 100%;height: 18.75rem;" v-for="typeItem in monitorTypes">
            </div>
        </el-card>
    </div>
</div>

<script>
		new Vue({
			el: '#app',
			data: function() {
				return {
					imgs:[], //展示图片的容器
					taskid: localStorage.getItem("taskid"),
					loading:true,
					slidesPerView: 5, //默认显示图片的张数
					realmonitorTypes:[], //真实的需要展示的图标
					isneedreportlog: false,
					allReportData: {}, //所有的结果集，自己查
					current_click_time_for_mountout: null, //被点击的时间00:00,所有的图标使用相同的时间。
					current_click_time_for_mountout_time: null, //被点击的真实时间
					monitorTypes:  ["cpu", "memory", "fps", "gpu", "devicebatterylevel", "devicebatterytemperature"],
					chartsMap:{
						//chats对象的数据集
						// "cpu": null,
						// "fps": null,
						// "memory": null,
						// "gpu": null,
					},
					chartOption:{
						title: {
						text: "",
						textStyle:{
							fontSize:24,
						}
						},
						grid: {
						left: '10%', // 左边距
							right: '5%', // 右边距
							top: '18%', // 上边距
							bottom: '24%', // 下边距            
						},
						animation: false,
						tooltip: {
						trigger: "axis",
						axisPointer: {
							type: "shadow",
						},
						},
						xAxis: {
						data: null // x 坐标
						},
						yAxis: {
						type: 'value',
						axisLabel: {
							formatter: '{value}'
						},
						},
						toolbox: {
						show: false,
						},
						brush: {
						xAxisIndex: "all",
						brushLink: "all",
						brushStyle: {
							borderWidth: 3,
							color: 'rgba(255,36,36,0.2)',
							borderColor: '#ff2424'
						}
						},
						series: {
						markArea:{},
						type: "line",
						clickable: true,
						symbol: 'circle',
						data: null, //y轴的值
						lineStyle: {
							width: 0.5,
						},
						showSymbol: false,//是否默认展示圆点
						},
					}
				}
			},
			async mounted() {
				this.$notify({
					title: '使用提示',
					dangerouslyUseHTMLString: true,
					message: '1.点击图表，显示对应时间的图片<br/>2.点击前后图片,<strong>图表红线会自动切换到对应位置</strong>',
					duration: 0
				});
				await this.getReportData()
				this.clearNoDataType()
				if (!this.allReportData.public_imgs || this.allReportData.public_imgs.length == 0 || this.allReportData.public_imgs.length == undefined) {
					return
				}
				this.current_click_time_for_mountout = this.allReportData.public_imgs? this.allReportData.public_imgs[parseInt(this.allReportData.public_imgs.length / 2)].relative_time : null
				this.current_click_time_for_mountout_time = this.allReportData.public_imgs? this.allReportData.public_imgs[parseInt(this.allReportData.public_imgs.length / 2)].time : null
				this.setAllBrush()
			},
			methods: {
				async getReportData(){
						await this.reportDataRecord().then(x=>{
						this.allReportData = x.data.result
						console.log("this.allReportData", this.allReportData)
						this.monitorTypes.forEach(t=>{
						try{
							this.createChart(t)
						}catch(e){
							console.error(e)
						}
						})
						this.addEvenClickForAllChart()
					})
				},
				clearNoDataType(){
					console.log("清除没有的图表")
					let showPicName= []
					let notShowPicName = []
					this.monitorTypes.forEach(e=>{
					if(this.allReportData[e]){
						showPicName.push(e)
					} else{
						if(e === 'devicebatterylevel'){
							notShowPicName.push('电量')
						}else if(e === 'devicebatterytemperature'){
							notShowPicName.push('温度')
						}else{
							notShowPicName.push(e)
						}
						
					} 
					})
					this.monitorTypes = showPicName
					if(notShowPicName.length > 0){
					this.$message.error(notShowPicName.toString() + '暂无数据', 2000);
					}
				},
				clickImg(item){
					this.allReportData.public_imgs.forEach(e=>{
						if(e.relative_time === item.relative_time){
							this.current_click_time_for_mountout = e.relative_time
							this.current_click_time_for_mountout_time = e.time
						}
					})
					this.setAllBrush()
				},
				//创建chart如果之前有chart就把之前的销毁
				createChart(chartName){
					let itemChart = this.chartsMap[chartName]
					if (itemChart){
						itemChart.dispose()
					}
					
					let currentChartDiv = document.getElementById(chartName);
					let nowChart = echarts.init(currentChartDiv);
					this.chartsMap[chartName] = nowChart
					this.setChartOptionRes(chartName, nowChart)
					return nowChart
				},
				setChartOptionRes(chartName, nowChart){
					this.chartOption.title.text = chartName.replace("devicebatterylevel", "电池电量")
															.replace("devicebatterytemperature", "电池温度")
															.replace("cpu","CPU")
															.replace("memory","MEMORY")
															.replace("gpu","GPU")
															.replace("fps","FPS")
					this.chartOption.xAxis.data = this.allReportData[chartName].relative_time
					this.chartOption.series.data = this.allReportData[chartName].value
					this.chartOption.xAxis.realtime = this.allReportData[chartName].time
					this.chartOption.yAxis.axisLabel.formatter = '{value}' +  this.findunit(chartName)
					nowChart.setOption(this.chartOption)
					return nowChart
				},
				findunit(chartName){
						const units = {
						"cpu": "%", 
						"gpu": "%",
						"fps": "帧",
						"memory": "M",
						"devicebatterylevel": "%",
						"devicebatterytemperature": "℃"
					};
					return units[chartName] || ""; // 如果没有找到对应的单位，返回一个空字符串
				},
				addEvenClickForAllChart(){
					for(const key in this.chartsMap){
						let myChart = this.chartsMap[key]
						myChart.getZr().on("click", (params) => {
						const pointInPixel = [params.offsetX, params.offsetY];
						if (myChart.containPixel("grid", pointInPixel)) {
							let xIndex = myChart.convertFromPixel({ seriesIndex: 0 }, [
							params.offsetX,
							params.offsetY,
							])[0];
							let current_key = this.allReportData[key].relative_time[xIndex];
							this.current_click_time_for_mountout = current_key;
							this.current_click_time_for_mountout_time = parseInt(this.allReportData[key].time[xIndex]); 
							console.log(key, xIndex, this.current_click_time_for_mountout_time, this.current_click_time_for_mountout, "current_click_time_for_mountout_time")
							this.setAllBrush()
						}
						});
					}
				},
				setAllBrush(){
					for(const key in this.chartsMap){
						this.setBrush(this.chartsMap[key])
					}
					if(this.allReportData.public_imgs){
						let itemImgInstance = null
						let choseIndex = 0
						for(let i = 0; i < this.allReportData.public_imgs.length; i++){
							if(this.allReportData.public_imgs[i].time === this.current_click_time_for_mountout_time){
								itemImgInstance = this.allReportData.public_imgs[i]
								choseIndex = i
								break
							}else if(this.allReportData.public_imgs[i].time > this.current_click_time_for_mountout_time){
								this.$message('当前时间点无图片，展示附近几张图片');
								itemImgInstance = this.allReportData.public_imgs[i]
								choseIndex = i
								break
							}
						}
						if (itemImgInstance){
							this.imgs = []
							this.loadImg(choseIndex)
						}
					}
				},
				setBrush (myChart) {
					myChart.dispatchAction({
						type: "brush",
						areas: [
						{
							brushType: "lineX",
							coordRange: [
							this.current_click_time_for_mountout,
							this.current_click_time_for_mountout,
							],
							xAxisIndex: 0,
							transformable: false,
						},
						],
					});
				},
				loadImg(choseIndex){
					for(let i = choseIndex - 1; i >= 0; i--){
						if(this.allReportData.public_imgs[i].picture_path){
							this.imgs.push(this.allReportData.public_imgs[i])
							break
						}	
					}
					this.imgs.push(this.allReportData.public_imgs[choseIndex])
					for(let i = choseIndex + 1; i < this.allReportData.public_imgs.length; i++){
						if(this.allReportData.public_imgs[i].picture_path){
							this.imgs.push(this.allReportData.public_imgs[i])
							break
						}	
					}
				},
				async loadImgwidthHeight(picture_path) {
					const img = new Image();
					img.src = picture_path;

					await new Promise((resolve, reject) => {
					img.onload = () => {
						const width = img.width;
						const height = img.height;
						const aspectRatio = width / height;
						// console.log("width", img.width, img.height)
						// 比较宽高比
						if (aspectRatio > 1) {
						this.slidesPerView = 5;
						} else if (aspectRatio < 1) {
						// console.log("aspectRatio", aspectRatio);
						this.slidesPerView = 7;
						} else {
						this.slidesPerView = 5;
						}

						resolve();
					};

					img.onerror = () => {
						reject();
					};
					});
				},
				async reportDataRecord(){
					const res = await axios({method: 'get',//提交方法
							url: '/result/',//提交地址
							params: {"id": this.taskid}
						}) 
					return res
				},
			}
		})

</script>
</body>
</html>
